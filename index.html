<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Cron√¥metro Capivara Clube</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
            background-image: url('https://source.unsplash.com/1600x900/?racing,track,circuit');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-blend-mode: overlay;
        }
        .dashboard-container {
            width: 100%;
            max-width: 1200px;
            background-color: rgba(18, 18, 18, 0.85);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
        }
        header {
            text-align: center;
            margin-bottom: 20px;
        }
        h1 {
            font-size: 2.8em;
            color: #4CAF50;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
            margin: 0;
            font-weight: bold;
        }
        header p {
            margin-top: 5px;
            font-size: 1.1em;
        }
        .live-section {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        .time-box, .record-box, .king-box {
            background-color: #1e1e1e;
            border: 2px solid #333;
            border-radius: 15px;
            padding: 20px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            text-align: center;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            cursor: default;
        }
        .time-box:hover, .record-box:hover, .king-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
        }
        .king-box {
            max-width: 950px;
            background-color: #2b2b2b;
            border-color: #FFC107;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .king-box h2 {
            color: #FFC107;
            font-size: 2.2em;
            font-weight: bold;
        }
        /* Estilos do novo layout do Rei da Pista */
        .king-info .tempo {
            font-size: 4em;
            font-weight: bold;
            color: #FFC107;
            font-family: 'Courier New', Courier, monospace;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
        }
        .king-info .piloto-info {
            font-size: 1.6em;
            color: #4CAF50;
            margin: 10px 0;
        }
        .king-info .pista-record {
            font-size: 1.2em;
            font-style: italic;
            color: #e0e0e0;
        }
        .record-box.new-record, .king-box.new-record {
            border-color: #FFC107;
            box-shadow: 0 0 25px rgba(255, 193, 7, 0.8);
            animation: flashBorder 1.5s infinite alternate, scaleUp 0.5s ease-in-out;
        }
        @keyframes flashBorder {
            0%, 100% { border-color: #FFC107; }
            50% { border-color: #ff5722; }
        }
        @keyframes scaleUp {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }
        .time-box h2, .status-box h2, .record-box h2 {
            margin: 0 0 10px;
            font-size: 1.6em;
            color: #4CAF50;
        }
        .time-display, .record-display {
            font-size: 4em;
            font-weight: bold;
            color: #FFC107;
            font-family: 'Courier New', Courier, monospace;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
        }
        .record-info {
            font-size: 1.2em;
            margin-top: 5px;
            color: #fff;
        }
        .ranking-section {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .category-ranking {
            background-color: #1e1e1e;
            border: 2px solid #333;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }
        .category-ranking h2 {
            background-color: #333;
            color: #4CAF50;
            margin: 0;
            padding: 15px;
            text-align: center;
            font-size: 1.8em;
            font-weight: bold;
            border-bottom: 2px solid #4CAF50;
        }
        .category-ranking table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1em;
        }
        .category-ranking th, .category-ranking td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #333;
            transition: background-color 0.3s;
        }
        .category-ranking th {
            background-color: #444;
            color: #e0e0e0;
            font-size: 1.1em;
            text-transform: uppercase;
        }
        .category-ranking tr:nth-child(even) {
            background-color: #2a2a2a;
        }
        .category-ranking tr:hover {
            background-color: #383838;
        }
        .category-ranking td:nth-child(6) {
            font-weight: bold;
            color: #FFC107;
        }
        .category-filter {
            margin-bottom: 20px;
            text-align: center;
        }
        .category-filter label, .category-filter select {
            font-size: 1.2em;
            color: #e0e0e0;
        }
        .category-filter select {
            background-color: #333;
            border: 1px solid #555;
            padding: 8px 12px;
            border-radius: 5px;
            color: #e0e0e0;
            cursor: pointer;
            outline: none;
            transition: border-color 0.3s;
        }
        .category-filter select:focus {
            border-color: #4CAF50;
        }
        .table-container {
            overflow-x: auto;
        }
        @media (max-width: 768px) {
            .live-section {
                flex-direction: column;
                align-items: center;
            }
            .time-box, .record-box, .king-box {
                max-width: 100%;
            }
            h1 {
                font-size: 2em;
            }
            .time-display, .record-display {
                font-size: 3em;
            }
            .king-info .tempo {
                font-size: 3em;
            }
            .king-info .piloto-info {
                font-size: 1.2em;
            }
            .king-info .pista-record {
                font-size: 1em;
            }
        }
    </style>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <header>
            <h1>Capivara Clube - Dashboard</h1>
            <p>Status da Conex√£o: <span id="connection-status" style="color: #FF5722;">Desconectado</span></p>
        </header>

        <div class="live-section">
            <div class="time-box">
                <h2>PISTA 1 - TEMPO FINAL</h2>
                <div id="pista1-time" class="time-display">00.000s</div>
            </div>
            <div class="time-box">
                <h2>PISTA 2 - TEMPO FINAL</h2>
                <div id="pista2-time" class="time-display">00.000s</div>
            </div>
        </div>

        <div class="live-section">
            <div class="record-box" id="record-pista1-box">
                <h2>RECORD PISTA 1</h2>
                <div id="record-pista1-time" class="record-display">0.000s</div>
                <div id="record-pista1-info" class="record-info">Aguardando...</div>
            </div>
            <div class="record-box" id="record-pista2-box">
                <h2>RECORD PISTA 2</h2>
                <div id="record-pista2-time" class="record-display">0.000s</div>
                <div id="record-pista2-info" class="record-info">Aguardando...</div>
            </div>
        </div>

        <div class="live-section">
            <div class="king-box">
                <h2>REI DA PISTA</h2>
                <div class="king-info">
                    <div id="king-time" class="tempo">0.000s</div>
                    <div id="king-piloto-info" class="piloto-info"></div>
                    <div id="king-track" class="pista-record"></div>
                </div>
            </div>
        </div>

        <div class="category-filter">
            <label for="categoria">Filtrar por Categoria:</label>
            <select id="categoria" onchange="processDataAndRender()"></select>
        </div>

        <div class="ranking-section">
            <div class="category-ranking">
                <h2>Ranking</h2>
                <div class="table-container">
                    <table id="ranking-table">
                        <thead>
                            <tr>
                                <th>Posi√ß√£o</th>
                                <th>Nome</th>
                                <th>Categoria</th>
                                <th>Melhor Tempo P1</th>
                                <th>Melhor Tempo P2</th>
                                <th>Somat√≥ria</th>
                                <th>Diferen√ßa</th>
                            </tr>
                        </thead>
                        <tbody id="ranking-body">
                            <tr>
                                <td colspan="7" style="text-align: center; color: #999;">Carregando dados...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO ---
        // üîë SUBSTITUA ESTA URL PELA SUA URL REAL DO WEB APP DO GOOGLE APPS SCRIPT
        const googleScriptURL = "https://script.google.com/macros/s/AKfycbwWXqUgtQ3toHno_H3c-7RkvWN6M4wRGbM2g2n2TVMG8qlIZpop0nPDos4phmb6kZg/exec";
        
        // üöÄ Configura√ß√µes MQTT (Mantidas, pois rodam localmente no navegador)
        const mqttServer = 'ws://192.168.0.178:9001'; 
        const clientId = 'web_dashboard_' + Math.random().toString(16).substr(2, 8);
        
        const TOPIC_TEMPO_FINAL_P1 = "cronometro/resultado/pista1";
        const TOPIC_TEMPO_FINAL_P2 = "cronometro/resultado/pista2";
        const TOPIC_LCD_STATUS = "cronometro/lcd";

        const client = mqtt.connect(mqttServer, { clientId: clientId });

        // Vari√°vel GLOBAL para armazenar os dados do Apps Script
        let globalRawData = [];

        const elements = {
            connectionStatus: document.getElementById('connection-status'),
            pista1Time: document.getElementById('pista1-time'),
            pista2Time: document.getElementById('pista2-time'),
            rankingBody: document.getElementById('ranking-body'),
            categoriaSelect: document.getElementById('categoria'),
            recordPista1Time: document.getElementById('record-pista1-time'),
            recordPista2Time: document.getElementById('record-pista2-time'),
            recordPista1Box: document.getElementById('record-pista1-box'),
            recordPista2Box: document.getElementById('record-pista2-box'),
            recordPista1Info: document.getElementById('record-pista1-info'),
            recordPista2Info: document.getElementById('record-pista2-info'),
            kingTime: document.getElementById('king-time'),
            kingPilotoInfo: document.getElementById('king-piloto-info'),
            kingTrack: document.getElementById('king-track')
        };
        
        const pistaRecords = {
            pista1: {
                record: Infinity,
                timeEl: elements.recordPista1Time,
                boxEl: elements.recordPista1Box,
                infoEl: elements.recordPista1Info,
                piloto: '',
                categoria: ''
            },
            pista2: {
                record: Infinity,
                timeEl: elements.recordPista2Time,
                boxEl: elements.recordPista2Box,
                infoEl: elements.recordPista2Info,
                piloto: '',
                categoria: ''
            }
        };

        // --- L√≥gica MQTT ---
        client.on('connect', () => {
            console.log('Conectado ao broker MQTT (Local).');
            elements.connectionStatus.textContent = 'Conectado (Local)';
            elements.connectionStatus.style.color = '#4CAF50';
            
            client.subscribe(TOPIC_TEMPO_FINAL_P1);
            client.subscribe(TOPIC_TEMPO_FINAL_P2);
            client.subscribe(TOPIC_LCD_STATUS);
        });

        client.on('error', (error) => {
            console.error('Erro de conex√£o MQTT:', error);
            elements.connectionStatus.textContent = 'Erro de Conex√£o (Local)';
            elements.connectionStatus.style.color = '#F44336';
        });
        
        client.on('close', () => {
            console.log('Conex√£o MQTT fechada.');
            elements.connectionStatus.textContent = 'Desconectado (Local)';
            elements.connectionStatus.style.color = '#FF5722';
        });

        client.on('message', (topic, message) => {
            const messageString = message.toString();
            // console.log(`Mensagem recebida no t√≥pico ${topic}: ${messageString}`);

            if (topic === TOPIC_TEMPO_FINAL_P1) {
                const tempo = parseFloat(messageString);
                elements.pista1Time.textContent = tempo.toFixed(3) + "s";
            } else if (topic === TOPIC_TEMPO_FINAL_P2) {
                const tempo = parseFloat(messageString);
                elements.pista2Time.textContent = tempo.toFixed(3) + "s";
            } else if (topic === TOPIC_LCD_STATUS) {
                if (messageString.includes("Pistas Liberadas")) {
                    elements.pista1Time.textContent = "00.000s";
                    elements.pista2Time.textContent = "00.000s";
                }
            }
        });

        // --- L√≥gica Apps Script (JSONP) ---
        
        /**
         * FUN√á√ÉO 1: Dispara a requisi√ß√£o JSONP ao Apps Script.
         */
        function requestDataFromGAS() {
            const scriptUrl = `${googleScriptURL}?callback=handleGASData`; 

            const existingScript = document.getElementById('gas-script');
            if (existingScript) {
                existingScript.remove();
            }

            const script = document.createElement('script');
            script.src = scriptUrl;
            script.id = 'gas-script';
            script.onerror = () => {
                console.error("Erro ao carregar o script do Apps Script.");
            };
            document.head.appendChild(script);
        }

        /**
         * FUN√á√ÉO 2: Callback do Apps Script. Armazena os dados e chama o processamento.
         */
        window.handleGASData = function(data) {
            if (data.status === 'error') {
                console.error(`Erro do Apps Script: ${data.message}`);
                return;
            }

            // ARMAZENA OS DADOS GLOBALMENTE
            globalRawData = data;
            
            // CHAMA A FUN√á√ÉO DE PROCESSAMENTO LOCAL
            processDataAndRender(); 
        }

        /**
         * FUN√á√ÉO 3: Processa os dados locais para gerar o ranking e atualizar caixas de recorde.
         * √â chamada ap√≥s receber novos dados ou quando o filtro muda.
         */
        function processDataAndRender() {
            const rawData = globalRawData;
            
            if (rawData.length === 0) {
                elements.rankingBody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: #999;">Nenhum dado de tempo encontrado no Apps Script.</td></tr>`;
                return;
            }

            // -------------------- 1. Mapeamento de Pilotos para encontrar Melhores Tempos --------------------
            const competidores = {};
            const categorias = new Set();
            
            rawData.forEach(item => {
                // Tenta pegar os dados do piloto 1
                let id = item.id_p1;
                let nome = item.nome_p1;
                let categoria = item.categoria_p1;

                if (!id) { // Se n√£o houver P1, tenta P2 (caso a linha s√≥ tenha P2)
                    id = item.id_p2;
                    nome = item.nome_p2;
                    categoria = item.categoria_p2;
                }
                
                if (!id || !nome || !categoria) return;

                categorias.add(categoria);

                if (!competidores[id]) {
                    competidores[id] = { id: id, nome: nome, categoria: categoria, melhorTempoP1: Infinity, melhorTempoP2: Infinity };
                }
                
                if (item.tempo_p1 > 0) {
                    competidores[id].melhorTempoP1 = Math.min(competidores[id].melhorTempoP1, item.tempo_p1);
                }
                if (item.tempo_p2 > 0) {
                    competidores[id].melhorTempoP2 = Math.min(competidores[id].melhorTempoP2, item.tempo_p2);
                }
            });

            // -------------------- 2. Encontrando Rei da Pista e Recordes Individuais --------------------
            let kingOfTheTrack = { tempo: Infinity, nome: '', categoria: '', pista: '' };
            let records = { pista1: { tempo: Infinity, nome: '', categoria: '' }, pista2: { tempo: Infinity, nome: '', categoria: '' } };

            rawData.forEach(item => {
                // Rei da Pista (melhor tempo geral)
                if (item.tempo_p1 > 0 && item.tempo_p1 < kingOfTheTrack.tempo) {
                    kingOfTheTrack.tempo = item.tempo_p1;
                    kingOfTheTrack.nome = item.nome_p1;
                    kingOfTheTrack.categoria = item.categoria_p1;
                    kingOfTheTrack.pista = 'Pista 1';
                }
                if (item.tempo_p2 > 0 && item.tempo_p2 < kingOfTheTrack.tempo) {
                    kingOfTheTrack.tempo = item.tempo_p2;
                    kingOfTheTrack.nome = item.nome_p2;
                    kingOfTheTrack.categoria = item.categoria_p2;
                    kingOfTheTrack.pista = 'Pista 2';
                }
                
                // Recorde da Pista 1
                if (item.tempo_p1 > 0 && item.tempo_p1 < records.pista1.tempo) {
                    records.pista1 = { tempo: item.tempo_p1, nome: item.nome_p1, categoria: item.categoria_p1 };
                }
                // Recorde da Pista 2
                if (item.tempo_p2 > 0 && item.tempo_p2 < records.pista2.tempo) {
                    records.pista2 = { tempo: item.tempo_p2, nome: item.nome_p2, categoria: item.categoria_p2 };
                }
            });

            // Atualiza o Rei da Pista
            if (kingOfTheTrack.tempo !== Infinity) {
                elements.kingTime.textContent = kingOfTheTrack.tempo.toFixed(3) + 's';
                elements.kingPilotoInfo.textContent = `${kingOfTheTrack.nome} - ${kingOfTheTrack.categoria}`;
                elements.kingTrack.textContent = kingOfTheTrack.pista;
            } else {
                elements.kingTime.textContent = '0.000s';
                elements.kingPilotoInfo.textContent = 'Aguardando tempos...';
                elements.kingTrack.textContent = '';
            }

            // Atualiza Recordes de Pista com anima√ß√£o
            const checkAndAnimateRecord = (newRecord, pistaId) => {
                const pista = pistaRecords[pistaId];
                if (newRecord.tempo > 0 && newRecord.tempo < pista.record) {
                    pista.record = newRecord.tempo;
                    pista.boxEl.classList.add('new-record');
                    setTimeout(() => {
                        pista.boxEl.classList.remove('new-record');
                    }, 3000);
                }
                // Atualiza a exibi√ß√£o
                if (newRecord.tempo !== Infinity) {
                    pista.timeEl.textContent = newRecord.tempo.toFixed(3) + 's';
                    pista.infoEl.textContent = `${newRecord.nome} - ${newRecord.categoria}`;
                } else {
                    pista.timeEl.textContent = '0.000s';
                    pista.infoEl.textContent = 'Aguardando...';
                }
            };

            checkAndAnimateRecord(records.pista1, 'pista1');
            checkAndAnimateRecord(records.pista2, 'pista2');

            // -------------------- 3. L√≥gica de Ranking e Filtro --------------------
            let rankingArray = Object.values(competidores)
                // O ranking s√≥ considera quem tem tempo nas duas pistas
                .filter(c => c.melhorTempoP1 !== Infinity && c.melhorTempoP2 !== Infinity)
                .map(c => ({
                    ...c,
                    somaMelhoresTempos: c.melhorTempoP1 + c.melhorTempoP2
                }))
                // Ordena pela soma dos melhores tempos (menor √© melhor)
                .sort((a, b) => a.somaMelhoresTempos - b.somaMelhoresTempos);

            // Recria as op√ß√µes do filtro
            const categoriasArray = ['TODOS', ...Array.from(categorias).sort()];
            const categoriaSelecionada = elements.categoriaSelect.value;
            
            if (elements.categoriaSelect.options.length === 0 || !categoriasArray.includes(categoriaSelecionada)) {
                 elements.categoriaSelect.innerHTML = categoriasArray.map(c => `<option value="${c}">${c}</option>`).join('');
                 elements.categoriaSelect.value = categoriaSelecionada || 'TODOS';
            }
            
            // Aplica o filtro se n√£o for "TODOS"
            if (categoriaSelecionada && categoriaSelecionada !== 'TODOS') {
                rankingArray = rankingArray.filter(c => c.categoria === categoriaSelecionada);
            }
            
            // Renderiza a tabela
            elements.rankingBody.innerHTML = '';
            
            if (rankingArray.length > 0) {
                const melhorTempoTotal = rankingArray[0].somaMelhoresTempos;
                rankingArray.forEach((competidor, index) => {
                    const diferenca = competidor.somaMelhoresTempos - melhorTempoTotal;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${competidor.nome}</td>
                        <td>${competidor.categoria}</td>
                        <td>${competidor.melhorTempoP1.toFixed(3) + 's'}</td>
                        <td>${competidor.melhorTempoP2.toFixed(3) + 's'}</td>
                        <td>${competidor.somaMelhoresTempos.toFixed(3) + 's'}</td>
                        <td>${diferenca > 0 ? '+' + diferenca.toFixed(3) + 's' : '-'}</td>
                    `;
                    elements.rankingBody.appendChild(row);
                });
            } else {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="7" style="text-align: center; color: #999;">Nenhum competidor com tempos registrados para ambas as pistas na categoria selecionada.</td>`;
                elements.rankingBody.appendChild(row);
            }
        }
        
        // --- INICIALIZA√á√ÉO E TIMER ---
        
        // Configura√ß√£o de Atualiza√ß√£o: 10 segundos para evitar a limita√ß√£o de requisi√ß√µes do Apps Script.
        setInterval(requestDataFromGAS, 10000); 
        
        document.addEventListener('DOMContentLoaded', () => {
            // Chamada inicial para carregar o ranking na primeira vez
            requestDataFromGAS(); 
        });
    </script>
</body>
</html>
